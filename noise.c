#include "stdafx.h"

#define SCALE16 16
#define FBM_SCALE 14

static int p[512];
static int permutation[256] = {
    151, 160, 137, 91, 90, 15, 131, 13, 201, 95, 96, 53, 194, 233, 7,
    225, 140, 36, 103, 30, 69, 142, 8, 99, 37, 240, 21, 10, 23, 190,
    6, 148, 247, 120, 234, 75, 0, 26, 197, 62, 94, 252, 219, 203, 117,
    35, 11, 32, 57, 177, 33, 88, 237, 149, 56, 87, 174, 20, 125, 136,
    171, 168, 68, 175, 74, 165, 71, 134, 139, 48, 27, 166, 77, 146, 158,
    231, 83, 111, 229, 122, 60, 211, 133, 230, 220, 105, 92, 41, 55, 46,
    245, 40, 244, 102, 143, 54, 65, 25, 63, 161, 1, 216, 80, 73, 209,
    76, 132, 187, 208, 89, 18, 169, 200, 196, 135, 130, 116, 188, 159, 86,
    164, 100, 109, 198, 173, 186, 3, 64, 52, 217, 226, 250, 124, 123, 5,
    202, 38, 147, 118, 126, 255, 82, 85, 212, 207, 206, 59, 227, 47, 16,
    58, 17, 182, 189, 28, 42, 223, 183, 170, 213, 119, 248, 152, 2, 44,
    154, 163, 70, 221, 153, 101, 155, 167, 43, 172, 9, 129, 22, 39, 253,
    19, 98, 108, 110, 79, 113, 224, 232, 178, 185, 112, 104, 218, 246, 97,
    228, 251, 34, 242, 193, 238, 210, 144, 12, 191, 179, 162, 241, 81, 51,
    145, 235, 249, 14, 239, 107, 49, 192, 214, 31, 181, 199, 106, 157, 184,
    84, 204, 176, 115, 121, 50, 45, 127, 4, 150, 254, 138, 236, 205, 93,
    222, 114, 67, 29, 24, 72, 243, 141, 128, 195, 78, 66, 215, 61, 156,
    180
};
static int fade_ary[256] = {
    0, 0, 0, 0, 0, 0, 1, 1, 1, 2, 2, 3,
    4, 5, 6, 8, 9, 11, 13, 15, 17, 20, 23, 26,
    29, 33, 37, 41, 45, 50, 55, 60, 66, 72, 78, 84,
    91, 98, 106, 114, 122, 130, 139, 148, 158, 168, 178, 189,
    200, 211, 223, 235, 247, 260, 273, 287, 300, 315, 329, 344,
    359, 375, 391, 407, 424, 441, 458, 476, 494, 513, 532, 551,
    570, 590, 610, 630, 651, 672, 694, 715, 737, 760, 782, 805,
    828, 852, 876, 900, 924, 948, 973, 998, 1024, 1049, 1075, 1101,
    1127, 1154, 1180, 1207, 1234, 1262, 1289, 1317, 1345, 1373, 1401, 1429,
    1458, 1486, 1515, 1544, 1573, 1602, 1631, 1661, 1690, 1720, 1749, 1779,
    1809, 1838, 1868, 1898, 1928, 1958, 1988, 2018, 2048, 2078, 2108, 2138,
    2168, 2198, 2228, 2258, 2287, 2317, 2347, 2376, 2406, 2435, 2465, 2494,
    2523, 2552, 2581, 2610, 2638, 2667, 2695, 2723, 2751, 2779, 2807, 2834,
    2862, 2889, 2916, 2942, 2969, 2995, 3021, 3047, 3072, 3098, 3123, 3148,
    3172, 3196, 3220, 3244, 3268, 3291, 3314, 3336, 3359, 3381, 3402, 3424,
    3445, 3466, 3486, 3506, 3526, 3545, 3564, 3583, 3602, 3620, 3638, 3655,
    3672, 3689, 3705, 3721, 3737, 3752, 3767, 3781, 3796, 3809, 3823, 3836,
    3849, 3861, 3873, 3885, 3896, 3907, 3918, 3928, 3938, 3948, 3957, 3966,
    3974, 3982, 3990, 3998, 4005, 4012, 4018, 4024, 4030, 4036, 4041, 4046,
    4051, 4055, 4059, 4063, 4067, 4070, 4073, 4076, 4079, 4081, 4083, 4085,
    4087, 4088, 4090, 4091, 4092, 4093, 4094, 4094, 4095, 4095, 4095, 4096,
    4096, 4096, 4096, 4096
};

static inline int MIN(int a, int b) { return a < b ? a : b; }

static inline int lerp(int t, int a, int b) { return a + (t * (b - a) >> 12); }

static int grad(int hash, int x, int y, int z)
{
    int h = hash & 15;
    int u = h < 8 ? x : y;
    int v = h < 4 ? y : h == 12 || h == 14 ? x
                                           : z;

    return ((h & 1) == 0 ? u : -u) + ((h & 2) == 0 ? v : -v);
}

static int fade(int t)
{
    int t0 = fade_ary[t >> 8];
    int t1 = fade_ary[MIN(255, (t >> 8) + 1)];

    return t0 + ((t & 255) * (t1 - t0) >> 8);
}

void noise_init()
{
    for (int i = 0; i < 256; i++) {
        p[256 + i] = p[i] = permutation[i];
    }
}

// result is between [-1<<SCALE16, 1<<SCALE16]
int noise_3d(int x, int y, int z)
{
    int X = x >> SCALE16 & 255;
    int Y = y >> SCALE16 & 255;
    int Z = z >> SCALE16 & 255;
    int N = 1 << SCALE16;

    x &= N - 1;
    y &= N - 1;
    z &= N - 1;

    int u = fade(x);
    int v = fade(y);
    int w = fade(z);

    int A = p[X] + Y;
    int B = p[X + 1] + Y;

    int AA = p[A] + Z;
    int AB = p[A + 1] + Z;

    int BA = p[B] + Z;
    int BB = p[B + 1] + Z;

    return lerp(
        w,
        lerp(v, lerp(u, grad(p[AA], x, y, z), grad(p[BA], x - N, y, z)),
            lerp(u, grad(p[AB], x, y - N, z), grad(p[BB], x - N, y - N, z))),
        lerp(v,
            lerp(u, grad(p[AA + 1], x, y, z - N),
                grad(p[BA + 1], x - N, y, z - N)),
            lerp(u, grad(p[AB + 1], x, y - N, z - N),
                grad(p[BB + 1], x - N, y - N, z - N))));
}

// result is between [-1<<FBM_SCALE, 1<<FBM_SCALE]
int noise_fbm(int iter, int x, int y, int z, int freq)
{
    int maxAmp = 0;
    int amp = 1 << FBM_SCALE;
    int noise = 0;

    for (int i = 0; i < iter; i++) {
        int n = noise_3d(x * freq, y * freq, z * freq) >> (SCALE16 - FBM_SCALE);
        noise += n * amp >> FBM_SCALE;

        maxAmp += amp;
        amp >>= 1;
        freq <<= 1;
    }

    return (noise << FBM_SCALE) / maxAmp;
}

int noise_wrap(int noise, int low, int high)
{
    return (noise * (high - low) >> FBM_SCALE) / 2 + (high + low) / 2;
}
